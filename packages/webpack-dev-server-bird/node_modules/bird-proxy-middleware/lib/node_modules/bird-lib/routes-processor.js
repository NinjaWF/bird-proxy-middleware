var birdUtils= require('bird-common/utils')

module.exports = {
    process: function(routes, pathname) {
        if (!routes.ordered) {
            // 重排 routes, 确保更精确的 route 定义在前面的位置
            routes.sort(function(a, b) {
                return a.test < b.test ? 1 : -1
            })
            routes.ordered = true

            // 检查 routes 定义的合理性 (是否多次定义)
            var tests = {}
            routes.map(function(route) {
                if (route.test in tests) {
                    birdUtils.logs(
                        ['warn', 'Bird 配置中, 发现重复的路由定义!!!'],
                        ['warn', route],
                        []
                    )
                } else {
                    tests[route.test] = route
                }
            })
        }

        var hitRouteInfo = null

        routes.some(function(route) {
            var rgx = new RegExp('^' + route.test)
            var result = rgx.exec(pathname)
            if (result) {
                hitRouteInfo = {route: route}
                
                hitRouteInfo.pathname = pathname

                if ('replace' in route) {
                    pathname = pathname.replace(rgx, route.replace)
                }

                if (route.static) {
                    hitRouteInfo.adjustedPathname = pathname.replace(rgx, '')
                } else if (route.mock) {
                    hitRouteInfo.adjustedPathname = route.mock
                } else {
                    hitRouteInfo.adjustedPathname = pathname
                }
                return true
            }
        })

        if (hitRouteInfo) {
            birdUtils.logs(
                ['debug', 'The route info found for `' + pathname + '` is '],
                ['debug', hitRouteInfo.route],
                [])
        } else {
            birdUtils.logs(
                ['debug', 'Cannot get a route info for `' + pathname + '`'],
                [])
        }
        
        return hitRouteInfo
    }
}
