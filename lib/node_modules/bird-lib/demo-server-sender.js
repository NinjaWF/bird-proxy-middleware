var request = require('request')
var utils = require('bird-common/utils')
var _ = require('lodash')

module.exports = function(config) {

    var metError = false, noDemos = false;

    var sendToDemoServer = function () {
        var demoServer = config.demoServer || '90paw.com'

        if (demoServer.substr != 'http://' || demoServer.substr != 'https://' ) {
            demoServer = 'http://' + demoServer
        }


        if (!config.demos || !_.keys(config.demos).length) {
            if (!noDemos) {
                utils.logs(
                    ['info', "You should set up the `config.demos` in order to make the UIUE demo server understand your local server's demo"]
                )
                noDemos = true;
            }
            return;
        } else {
            noDemos = false;
        }

        request.post(demoServer + '/getBird', {
            form: {
                name: config.name,
                port: config.birdPort,
                demos: config.demos
            }
        }, function (error, response, body) {
            // console.log(response)
            
            if (error) {
                if (!metError) {
                    utils.logs(
                        ['warn', 'The demo server is not up, please check what happen to the server : ' + demoServer + '/getBird?name=' + encodeURIComponent(config.name) + '&port=' + encodeURIComponent(config.birdPort)],
                        ['warn', "While bird server will be running, your local server info won't be sent to the demo server"],
                        // ['error', error],
                        ['hint', 'Maybe you have set a wrong demo server url on your config file? '],
                        ['hint', 'Maybe your demo server is down? ']
                    )
                    metError = true
                }
            } else {
                metError = false
            }
        })
    }

    // send request to the plantform
    setInterval(sendToDemoServer, 20000)
    sendToDemoServer()
}
